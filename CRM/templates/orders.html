{% extends "base.html" %}

{% block title %}Заказы {{ customer.full_name() }} - CRM System{% endblock %}

{% block content %}
<div class="header-actions">
    <div>
        <h2><i class="fas fa-shopping-cart"></i> Заказы клиента</h2>
        <p class="subtitle">{{ customer.full_name() }} • {{ customer.phone }}</p>
    </div>
    <div>
        <a href="{{ url_for('customers') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> К списку клиентов
        </a>
    </div>
</div>

<div class="card">
    <div class="customer-info">
        <div class="info-item">
            <strong>ФИО:</strong> {{ customer.full_name() }}
        </div>
        <div class="info-item">
            <strong>Телефон:</strong> {{ customer.phone }}
        </div>
        {% if customer.email %}
        <div class="info-item">
            <strong>Email:</strong> {{ customer.email }}
        </div>
        {% endif %}
        <div class="info-item">
            <strong>Дата регистрации:</strong> {{ customer.registration_date.strftime('%d.%m.%Y') }}
        </div>
        {% if customer.notes %}
        <div class="info-item">
            <strong>Примечания:</strong> {{ customer.notes }}
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <h3><i class="fas fa-plus-circle"></i> Добавить заказ</h3>
    <form method="post" action="{{ url_for('add_order', customer_id=customer.id) }}" class="form">
        <div class="form-row">
            <div class="form-group">
                <label for="order_date">Дата заказа</label>
                <input type="date" 
                       id="order_date" 
                       name="order_date" 
                       value="{{ today.strftime('%Y-%m-%d') }}" 
                       required
                       class="form-control">
            </div>
            
            <div class="form-group">
                <label for="product_name">Товар/Услуга</label>
                <input type="text" 
                       id="product_name" 
                       name="product_name" 
                       required
                       class="form-control"
                       placeholder="Наименование товара или услуги">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="quantity">Количество</label>
                <input type="number" 
                       id="quantity" 
                       name="quantity" 
                       value="1" 
                       required
                       min="1"
                       class="form-control">
            </div>
            
            <div class="form-group">
                <label for="price">Цена</label>
                <input type="number" 
                       id="price" 
                       name="price" 
                       step="0.01" 
                       required
                       min="0"
                       class="form-control"
                       placeholder="0.00">
            </div>
            
            <div class="form-group">
                <label for="status">Статус</label>
                <select id="status" name="status" class="form-control">
                    <option value="active" selected>Активный</option>
                    <option value="completed">Завершен</option>
                    <option value="cancelled">Отменен</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">Примечания к заказу</label>
            <textarea id="notes" 
                      name="notes" 
                      rows="3"
                      class="form-control"
                      placeholder="Дополнительная информация о заказе"></textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Добавить заказ
            </button>
        </div>
    </form>
</div>

{% if orders %}
<div class="card">
    <h3><i class="fas fa-list"></i> История заказов</h3>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Товар/Услуга</th>
                    <th>Кол-во</th>
                    <th>Цена</th>
                    <th>Сумма</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>{{ order.order_date.strftime('%d.%m.%Y') }}</td>
                    <td>{{ order.product_name }}</td>
                    <td>{{ order.quantity }}</td>
                    <td>{{ "%.2f"|format(order.price) }} ₽</td>
                    <td>{{ "%.2f"|format(order.total_price) }} ₽</td>
                    <td>
                        <form method="post" action="{{ url_for('update_order_status', order_id=order.id) }}" class="status-form">
                            <select name="status" class="status-select" onchange="this.form.submit()">
                                <option value="active" {% if order.status == 'active' %}selected{% endif %}>Активный</option>
                                <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Завершен</option>
                                <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Отменен</option>
                            </select>
                        </form>
                    </td>
                    <td>
                        <div class="action-buttons">
                            {% if order.notes %}
                            <button class="btn-icon" 
                                    title="Показать примечания" 
                                    onclick="showOrderNotes('{{ order.id }}', '{{ order.product_name }}', '{{ order.notes }}')">
                                <i class="fas fa-sticky-note"></i>
                            </button>
                            {% endif %}
                            <form method="post" 
                                  action="{{ url_for('delete_order', order_id=order.id) }}" 
                                  onsubmit="return confirm('Вы уверены, что хотите удалить заказ \x22{{ order.product_name }}\x22?')"
                                  style="display: inline;">
                                <button type="submit" class="btn-icon btn-danger" title="Удалить заказ">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <div class="stats">
        <div class="stat-item">
            <div class="stat-value">{{ orders|length }}</div>
            <div class="stat-label">Всего заказов</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">
                {% set total_sum = 0 %}
                {% for order in orders %}
                    {% set total_sum = total_sum + order.total_price %}
                {% endfor %}
                {{ "%.2f"|format(total_sum) }} ₽
            </div>
            <div class="stat-label">Общая сумма</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">
                {% set active_count = 0 %}
                {% for order in orders %}
                    {% if order.status == 'active' %}
                        {% set active_count = active_count + 1 %}
                    {% endif %}
                {% endfor %}
                {{ active_count }}
            </div>
            <div class="stat-label">Активных заказов</div>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <i class="fas fa-shopping-cart"></i>
        <h3>Нет заказов</h3>
        <p>У этого клиента еще нет добавленных заказов.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Функция для безопасного отображения примечаний
    function showOrderNotes(orderId, productName, notes) {
        // Экранируем специальные символы для безопасного отображения в alert
        const safeNotes = notes.replace(/\\/g, '\\\\')
                               .replace(/\n/g, '\\n')
                               .replace(/'/g, "\\'")
                               .replace(/"/g, '\\"');
        
        alert('Заказ #' + orderId + '\nТовар: ' + productName + '\n\nПримечания:\n' + safeNotes);
    }
</script>
{% endblock %}